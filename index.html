<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paul's Tesla M3P — Dashboard</title>

<script src="https://unpkg.com/feather-icons"></script>

<style>
  :root{
    --bg-card: rgba(255,255,255,0.10);
    --muted: rgba(255,255,255,0.75);
    --divider: rgba(255,255,255,0.12);
  }

  /* Base / large-screen sizing */
  html, body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: radial-gradient(circle at center,#070707 0%, #000 70%);
    color: #eaeaea;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    font-size: 18px; /* large base for car screen */
  }

  .page{
    max-width:1400px;
    margin:28px auto;
    padding:0 24px 60px;
  }

  .top-banner{
    display:flex;
    justify-content:flex-start;
    align-items:center;
    gap:18px;
    padding:16px 22px;
    background:var(--bg-card);
    border-radius:14px;
    margin-bottom:20px;
    border:1px solid rgba(255,255,255,0.06);
    backdrop-filter: blur(8px);
  }

  /* Date/time and vehicle label */
  #topTime {
    font-weight:700;
    font-size:2.2rem; /* slightly smaller so it stays on one line in partial browser */
    line-height:1;
    letter-spacing:0.4px;
  }

  #vehicleLabel {
    font-size:1.25rem;
    opacity:0.9;
    margin-left:12px;
    padding:6px 10px;
    border-radius:8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.04);
  }

  .grid{
    display:grid;
    grid-template-columns: 1.1fr 1fr;
    gap:22px;
  }

  @media (max-width:1200px){
    .grid{ grid-template-columns: 1fr; }
  }

  .card{
    background:var(--bg-card);
    padding:22px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.06);
    box-shadow: 0 10px 28px rgba(0,0,0,0.6), inset 0 0 14px rgba(255,255,255,0.03);
  }

  .card-header{
    display:flex;
    align-items:center;
    gap:12px;
    font-weight:700;
    margin-bottom:12px;
    opacity:0.98;
    font-size:1.6rem;
  }

  /* Weather Hub */
  #weatherHub .weather-main{
    display:flex;
    gap:18px;
    align-items:center;
  }

  .weather-icon-big{
    width:140px; /* reduced from earlier extremes */
    height:140px;
    flex:0 0 140px;
    filter: drop-shadow(0 8px 28px rgba(0,0,0,0.6));
  }

  .weather-temp{
    font-size:3.6rem; /* reduced */
    font-weight:700;
    line-height:1;
  }

  .weather-sub{
    margin-top:6px;
    color:var(--muted);
    font-size:1.2rem; /* reduced */
  }

  .sunrise-icon, .sunset-icon{
    width:30px;
    height:30px;
    vertical-align:middle;
  }

  .weather-divider{
    border:none;
    border-top:1px solid var(--divider);
    margin:14px 0;
  }

  /* Radar map */
  .radar-wrap{
    width:100%;
    height:240px; /* comfortable height for car screen */
    border-radius:12px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.06);
    background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06));
  }
  .radar-iframe{
    width:100%;
    height:100%;
    border:0;
    display:block;
  }

  /* Hourly (every 3 hours, 6 entries) */
  .hourly-container{ overflow-x:auto; padding-bottom:8px; }
  .hourly-strip{ display:flex; gap:12px; min-width:max-content; align-items:flex-start; }
  .hourly-item{
    min-width:150px;
    padding:10px;
    border-radius:12px;
    background:rgba(255,255,255,0.03);
    text-align:center;
    font-size:1.2rem;
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:center;
  }
  .hourly-item img{ width:72px; height:72px; }
  .hourly-time{ opacity:0.9; font-size:1.2rem; }
  .hourly-temp{ font-weight:700; font-size:1.25rem; }
  .hourly-pop{ font-size:1rem; color:var(--muted); }
  .hourly-wind{ font-size:1rem; color:var(--muted); display:flex; gap:8px; align-items:center; }
  .wind-icon{ width:28px; height:28px; opacity:0.95; }

  /* 5-day condensed */
  #weatherDaily{ margin-top:10px; }
  .forecast-row{
    display:flex;
    align-items:center;
    gap:12px;
    padding:8px 0;
    border-bottom:1px solid rgba(255,255,255,0.06);
    font-size:1.1rem;
    line-height:1.05;
  }
  .forecast-row:last-child{ border-bottom:none; }
  .forecast-day{ width:72px; opacity:0.95; font-weight:700; font-size:1.15rem; }
  .forecast-icon{ width:64px; flex:0 0 64px; text-align:center; }
  .forecast-icon img{ width:56px; height:56px; }
  .forecast-temps{ width:130px; text-align:right; font-weight:700; font-size:1.1rem; }
  .forecast-pop{ width:72px; text-align:right; color:var(--muted); font-size:1rem; }
  .forecast-wind{ width:120px; text-align:right; color:var(--muted); font-size:1rem; display:flex; gap:8px; justify-content:flex-end; align-items:center; }
  .wind-icon-small{ width:22px; height:22px; opacity:0.9; }

  /* Trend arrow */
  .trend {
    display:inline-block;
    margin-left:12px;
    font-size:1.2rem;
    opacity:0.95;
  }

  /* temp color helpers */
  .temp-hot{ color:#ff6b6b; }
  .temp-warm{ color:#ffa94d; }
  .temp-mild{ color:#ffd43b; }
  .temp-cool{ color:#4fa3ff; }
  .temp-low-deep{ color:#4fa3ff; }
  .muted { color:var(--muted); }

  /* Calendar & events */
  .calendar-summary{ font-size:1.2rem; opacity:0.95; margin-bottom:8px; }
  .now-next-later{ margin-top:8px; font-size:1.05rem; }
  .nnl-label{ font-weight:700; font-size:1.05rem; }
  .nnl-text{ font-size:1.05rem; color:var(--muted); }

  .events-list{ margin-top:12px; }
  .event{ padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.06); cursor:pointer; font-size:1.1rem; }
  .event-main{ display:flex; gap:12px; align-items:center; }
  .event-dot{ width:12px; height:12px; border-radius:50%; }
  .event-time{ min-width:90px; font-weight:700; font-size:1.05rem; }
  .event-details{ display:none; padding-left:36px; opacity:0.85; font-size:1rem; }
  .event.expanded .event-details{ display:block; }

  /* shortcuts */
  .shortcuts{ display:flex; gap:16px; flex-wrap:wrap; margin-top:12px; }
  .shortcut-btn{ min-width:220px; padding:14px 18px; border-radius:14px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.03); cursor:pointer; display:flex; gap:12px; align-items:center; justify-content:center; font-size:1.05rem; }
</style>
</head>
<body>
  <div class="page">
    <div class="top-banner">
      <div>
        <div id="topTime">--</div>
        <div id="vehicleLabel">Paul's Tesla M3P</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Weather Hub -->
      <div>
        <div class="card" id="weatherHub">
          <div class="card-header"><i data-feather="cloud"></i><span>Weather</span></div>

          <div id="weatherCurrent"></div>

          <div class="weather-divider"></div>

          <!-- Radar map centered on ZIP 01075 (South Hadley, MA) -->
          <div class="radar-wrap" id="radarWrap" aria-hidden="false">
            <!-- RainViewer embed centered on 42.2481415,-72.5796331 with zoom focused on MA/CT region -->
            <iframe
              class="radar-iframe"
              src="https://www.rainviewer.com/map.html?loc=42.2481415,-72.5796331&z=8&overlay=radar&product=radar&opacity=0.75&play=true"
              title="Radar map centered on 01075"
              loading="lazy"
              referrerpolicy="no-referrer"
            ></iframe>
          </div>

          <div class="weather-divider"></div>

          <div id="weatherHourly"></div>

          <div class="weather-divider"></div>

          <div id="weatherDaily"></div>

          <div class="insight" id="weatherInsight" style="font-size:1.05rem; margin-top:12px;"></div>
        </div>
      </div>

      <!-- RIGHT: Calendar -->
      <div>
        <div class="card">
          <div class="card-header"><i data-feather="calendar"></i><span>Today’s Schedule</span></div>
          <div class="calendar-summary" id="calendarSummary">Loading your day…</div>
          <div class="now-next-later" id="nowNextLater"></div>
        </div>

        <div class="card" style="margin-top:18px;">
          <div class="card-header"><i data-feather="list"></i><span>All Events Today & Tomorrow</span></div>
          <div class="events-list" id="calendarEvents">Loading events…</div>
        </div>

        <div class="card" style="margin-top:18px;">
          <div class="card-header"><i data-feather="zap"></i><span>Shortcuts</span></div>
          <div class="shortcuts">
            <button class="shortcut-btn" onclick="window.location.href='https://us83.tribalwars.us/game.php?village=2878&screen=main'"><i data-feather="target"></i> Game</button>
            <button class="shortcut-btn" onclick="window.location.href='https://dash.tessie.com/'"><i data-feather="cpu"></i> Tessie</button>
            <button class="shortcut-btn"><i data-feather="star"></i> Coming Soon</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
feather.replace();

// Clock — slightly smaller so it stays on one line in partial browser width
function updateTime(){
  const now = new Date();
  const dateStr = now.toLocaleDateString([], { weekday:'long', month:'long', day:'numeric' });
  const timeStr = now.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' });
  document.getElementById('topTime').textContent = `${dateStr}  |  ${timeStr}`;
}
setInterval(updateTime,1000);
updateTime();

/* CONFIG */
const OPENWEATHER_API_KEY = "89c3522f7c542a2f0aaa7cacf8d6ef28";
const LAT = 42.2043;
const LON = -72.6162;
const UNITS = "imperial";

/* Robust icon loader */
function createIconImg(primary, fallback1, fallback2, className = "", alt = "") {
  const img = document.createElement("img");
  img.src = primary;
  if (className) img.className = className;
  img.alt = alt || "";
  img.dataset._tried = "0";
  img.onerror = function () {
    if (img.dataset._tried === "0") {
      img.dataset._tried = "1";
      if (fallback1) img.src = fallback1;
      else if (fallback2) img.src = fallback2;
      else img.style.display = "none";
    } else if (img.dataset._tried === "1") {
      img.dataset._tried = "2";
      if (fallback2) img.src = fallback2;
      else img.style.display = "none";
    } else {
      img.style.display = "none";
    }
  };
  return img;
}
function openWeatherIconUrl(iconCode) {
  return `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
}

/* ICON HELPERS */
function meteoconAnimated(iconCode){
  const map = {"01d":"clear-day","01n":"clear-night","02d":"partly-cloudy-day","02n":"partly-cloudy-night","03d":"cloudy","03n":"cloudy","04d":"overcast","04n":"overcast","09d":"rain","09n":"rain","10d":"rain","10n":"rain","11d":"thunderstorms","11n":"thunderstorms","13d":"snow","13n":"snow","50d":"mist","50n":"mist"};
  const key = map[iconCode] || "cloudy";
  return `https://basmilius.github.io/weather-icons/production/animated/${key}.svg`;
}
function meteoconStatic(iconCode){
  const map = {"01d":"clear-day","01n":"clear-night","02d":"partly-cloudy-day","02n":"partly-cloudy-night","03d":"cloudy","03n":"cloudy","04d":"overcast","04n":"overcast","09d":"rain","09n":"rain","10d":"rain","10n":"rain","11d":"thunderstorms","11n":"thunderstorms","13d":"snow","13n":"snow","50d":"mist","50n":"mist"};
  const key = map[iconCode] || "cloudy";
  return `https://basmilius.github.io/weather-icons/production/fill/all/${key}.svg`;
}
function windIconAnimated(speed){
  const b = Math.min(12, Math.max(0, Math.round(speed / 5)));
  return `https://basmilius.github.io/weather-icons/production/animated/wind-beaufort-${b}.svg`;
}
function windIconStatic(speed){
  const b = Math.min(12, Math.max(0, Math.round(speed / 5)));
  return `https://basmilius.github.io/weather-icons/production/fill/all/wind-beaufort-${b}.svg`;
}

/* Narrative */
function generateWeatherNarrative(current, forecast){
  const desc = current.weather[0].description;
  const temp = Math.round(current.main.temp);
  let narrative = `It’s ${temp}°F and ${desc}.`;
  if (desc.toLowerCase().includes('snow')) narrative += ' Roads may be slick — allow extra travel time.';
  if (desc.toLowerCase().includes('rain')) narrative += ' Expect wet conditions and reduced visibility.';
  if (desc.toLowerCase().includes('wind')) narrative += ' Gusty winds possible — secure loose items.';
  if (desc.toLowerCase().includes('storm')) narrative += ' Thunderstorms possible — stay alert.';
  const next6 = forecast.list.slice(0,6).map(f=>f.weather[0].main.toLowerCase());
  if (next6.some(w=>w.includes('snow'))) narrative += ' Snow is expected soon.';
  if (next6.some(w=>w.includes('rain'))) narrative += ' Rain likely in the next hours.';
  return narrative;
}

/* Temperature color helper */
function colorTempStyle(t, isLow=false){
  if(isLow){
    if(t < 32) return "color:#4fa3ff";
    if(t < 50) return "color:#7fbaff";
    return "color:#cfcfcf";
  } else {
    if(t >= 85) return "color:#ff6b6b";
    if(t >= 70) return "color:#ffa94d";
    if(t >= 50) return "color:#ffd43b";
    return "color:#4fa3ff";
  }
}

/* Fetch weather */
async function loadWeather(){
  try{
    const currentUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&units=${UNITS}&appid=${OPENWEATHER_API_KEY}`;
    const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${LAT}&lon=${LON}&units=${UNITS}&appid=${OPENWEATHER_API_KEY}`;
    const [curRes, fRes] = await Promise.all([fetch(currentUrl), fetch(forecastUrl)]);
    const current = await curRes.json();
    const forecast = await fRes.json();
    renderCurrentWeather(current);
    renderHourly(forecast);   // now every 3 hours, 6 entries
    renderForecast(forecast);
    document.getElementById('weatherInsight').textContent = generateWeatherNarrative(current, forecast);
  }catch(err){
    console.error('Weather load error', err);
    document.getElementById('weatherCurrent').textContent = 'Weather unavailable';
  }
}

/* Render current */
function renderCurrentWeather(data){
  const temp = Math.round(data.main.temp);
  const feels = Math.round(data.main.feels_like);
  const desc = data.weather[0].description;
  const city = data.name;
  const iconCode = data.weather[0].icon;
  const sunrise = new Date(data.sys.sunrise * 1000).toLocaleTimeString([], { hour:'numeric', minute:'2-digit' });
  const sunset = new Date(data.sys.sunset * 1000).toLocaleTimeString([], { hour:'numeric', minute:'2-digit' });

  const animated = meteoconAnimated(iconCode);
  const staticIcon = meteoconStatic(iconCode);
  const owFallback = openWeatherIconUrl(iconCode);

  document.getElementById('weatherCurrent').innerHTML = `
    <div class="weather-main">
      <div id="weatherIconWrap"></div>
      <div>
        <div class="weather-temp">${temp}°F</div>
        <div class="weather-sub">${city} • ${desc}</div>
        <div class="weather-sub">Feels like ${feels}°F</div>
        <div class="weather-sub" id="sunTimes"></div>
      </div>
    </div>
  `;

  const iconImg = createIconImg(animated, staticIcon, owFallback, "weather-icon-big", desc);
  document.getElementById('weatherIconWrap').appendChild(iconImg);

  const sunriseAnimated = 'https://basmilius.github.io/weather-icons/production/animated/sunrise.svg';
  const sunriseStatic = 'https://basmilius.github.io/weather-icons/production/fill/all/sunrise.svg';
  const sunsetAnimated = 'https://basmilius.github.io/weather-icons/production/animated/sunset.svg';
  const sunsetStatic = 'https://basmilius.github.io/weather-icons/production/fill/all/sunset.svg';

  const sunriseImg = createIconImg(sunriseAnimated, sunriseStatic, '', 'sunrise-icon', 'sunrise');
  const sunsetImg  = createIconImg(sunsetAnimated, sunsetStatic, '', 'sunset-icon', 'sunset');

  const sunTimes = document.getElementById('sunTimes');
  sunTimes.appendChild(sunriseImg);
  sunTimes.insertAdjacentHTML('beforeend', ` ${sunrise} &nbsp;&nbsp;`);
  sunTimes.appendChild(sunsetImg);
  sunTimes.insertAdjacentHTML('beforeend', ` ${sunset}`);
}

/* Render hourly (every 3 hours, 6 entries) */
function renderHourly(data){
  const container = document.getElementById('weatherHourly');
  container.innerHTML = `
    <div class="card-header" style="margin:0; padding:0 0 8px 0;"><i data-feather="clock"></i><span>Every 3 Hours (6 updates)</span></div>
    <div class="hourly-container"><div class="hourly-strip" id="hourlyStrip"></div></div>
  `;
  feather.replace();

  const strip = document.getElementById('hourlyStrip');
  strip.innerHTML = '';

  const now = Date.now();
  // OpenWeather 3-hourly forecast; take the next 6 entries (each is 3 hours apart)
  const upcoming = data.list.filter(e => e.dt * 1000 > now).slice(0,6);

  upcoming.forEach(entry => {
    const dt = new Date(entry.dt * 1000);
    const timeLabel = dt.toLocaleTimeString([], { hour:'numeric' });
    const temp = Math.round(entry.main.temp);
    const iconCode = entry.weather[0].icon;
    const animatedIcon = meteoconAnimated(iconCode);
    const staticIcon = meteoconStatic(iconCode);
    const owIcon = openWeatherIconUrl(iconCode);
    const pop = Math.round((entry.pop || 0) * 100);
    const wind = Math.round(entry.wind?.speed || 0);

    const iconElement = createIconImg(animatedIcon, staticIcon, owIcon, '', entry.weather[0].description);
    const windImg = createIconImg(windIconAnimated(wind), windIconStatic(wind), '', 'wind-icon', 'wind');

    const div = document.createElement('div');
    div.className = 'hourly-item';
    div.innerHTML = `
      <div class="hourly-time">${timeLabel}</div>
      <div class="hourly-icon-wrap"></div>
      <div class="hourly-temp">${temp}°</div>
      <div class="hourly-pop">${pop}%</div>
      <div class="hourly-wind"></div>
    `;
    div.querySelector('.hourly-icon-wrap').appendChild(iconElement);
    const windWrap = div.querySelector('.hourly-wind');
    windWrap.appendChild(windImg);
    windWrap.insertAdjacentHTML('beforeend', `${wind} mph`);
    strip.appendChild(div);
  });

  if(upcoming.length === 0) strip.textContent = 'No upcoming 3-hour entries available.';
}

/* Render 5-day */
function renderForecast(data){
  const container = document.getElementById('weatherDaily');
  container.innerHTML = `
    <div class="card-header" style="margin:0; padding:0 0 8px 0;"><i data-feather="cloud-snow"></i><span id="forecastHeader">5‑Day Forecast</span></div>
    <div id="forecastContainer"></div>
  `;
  feather.replace();

  const fc = document.getElementById('forecastContainer');
  fc.innerHTML = '';

  const byDay = {};
  data.list.forEach(entry => {
    const dt = new Date(entry.dt * 1000);
    const key = dt.toISOString().slice(0,10);
    if(!byDay[key] || Math.abs(dt.getHours() - 12) < Math.abs(new Date(byDay[key].dt * 1000).getHours() - 12)){
      byDay[key] = entry;
    }
  });

  const days = Object.keys(byDay).slice(0,5);

  let trendSymbol = '';
  if(days.length >= 2){
    const d0 = Math.round(byDay[days[0]].main.temp_max || byDay[days[0]].main.temp);
    const d1 = Math.round(byDay[days[1]].main.temp_max || byDay[days[1]].main.temp);
    trendSymbol = d1 > d0 ? '↑' : (d1 < d0 ? '↓' : '→');
    document.getElementById('forecastHeader').textContent = `5‑Day Forecast ${trendSymbol}`;
  }

  days.forEach(dayKey => {
    const entry = byDay[dayKey];
    const dt = new Date(entry.dt * 1000);
    const label = dt.toLocaleDateString([], { weekday:'short' });
    const min = Math.round(entry.main.temp_min || entry.main.temp);
    const max = Math.round(entry.main.temp_max || entry.main.temp);
    const iconCode = entry.weather[0].icon;
    const staticIcon = meteoconStatic(iconCode);
    const owIcon = openWeatherIconUrl(iconCode);
    const pop = Math.round((entry.pop || 0) * 100);
    const wind = Math.round(entry.wind?.speed || 0);

    const iconEl = createIconImg(staticIcon, owIcon, '', '', entry.weather[0].description);
    const windImg = createIconImg(windIconStatic(wind), '', '', 'wind-icon-small', 'wind');

    const row = document.createElement('div');
    row.className = 'forecast-row';

    const dayDiv = document.createElement('div'); dayDiv.className = 'forecast-day'; dayDiv.textContent = label;
    const iconDiv = document.createElement('div'); iconDiv.className = 'forecast-icon'; iconDiv.appendChild(iconEl);
    const tempsDiv = document.createElement('div'); tempsDiv.className = 'forecast-temps';
    tempsDiv.innerHTML = `<span style="${colorTempStyle(max,false)}">${max}°</span>&nbsp;/&nbsp;<span style="${colorTempStyle(min,true)}">${min}°</span>`;
    const windDiv = document.createElement('div'); windDiv.className = 'forecast-wind'; windDiv.appendChild(windImg); windDiv.insertAdjacentHTML('beforeend', `${wind} mph`);
    const popDiv = document.createElement('div'); popDiv.className = 'forecast-pop'; popDiv.textContent = `${pop}%`;

    row.appendChild(dayDiv);
    row.appendChild(iconDiv);
    row.appendChild(tempsDiv);
    row.appendChild(windDiv);
    row.appendChild(popDiv);

    fc.appendChild(row);
  });
}

/* --- Calendar code (unchanged) --- */
const CALENDARS = [
  { name: "Personal", key: "personal", url: "https://calendar.google.com/calendar/ical/pskandelmail%40gmail.com/private-3f860a04fb0570102688170b52564c42/basic.ics", color: "#4f9cff" },
  { name: "Kenyon", key: "kenyon", url: "https://pskandel1431.github.io/tesla-dashboard/calendars/kenyon.ics", color: "#9b59b6" },
  { name: "Family", key: "family", url: "https://calendar.google.com/calendar/ical/eiusan2qer3qb66dragfdqv6n4%40group.calendar.google.com/private-6aa24b9fdb6c890da5038ca012dfd501/basic.ics", color: "#27ae60" }
];

function parseICalDate(value){
  const raw = value.split(':').pop();
  if(!raw.includes('T')){
    const y=Number(raw.slice(0,4)), m=Number(raw.slice(4,6))-1, d=Number(raw.slice(6,8));
    return new Date(y,m,d);
  }
  const [datePart,timePartRaw] = raw.split('T');
  const timePart = timePartRaw.replace('Z','');
  const y=Number(datePart.slice(0,4)), m=Number(datePart.slice(4,6))-1, d=Number(datePart.slice(6,8));
  const hh=Number(timePart.slice(0,2)), mm=Number(timePart.slice(2,4)), ss=Number(timePart.slice(4,6) || '0');
  const isUTC = timePartRaw.endsWith('Z');
  return isUTC ? new Date(Date.UTC(y,m,d,hh,mm,ss)) : new Date(y,m,d,hh,mm,ss);
}

function parseICS(text, sourceKey){
  const events=[];
  const lines = text.split(/\r?\n/);
  let current=null;
  for(let line of lines){
    if(line.startsWith('BEGIN:VEVENT')) current={};
    else if(line.startsWith('END:VEVENT')){
      if(current && current.DTSTART && current.SUMMARY){
        events.push({ title: current.SUMMARY, start: parseICalDate(current.DTSTART), end: current.DTEND ? parseICalDate(current.DTEND) : null, sourceKey });
      }
      current=null;
    } else if(current){
      const [key,...rest] = line.split(':');
      const value = rest.join(':');
      if(key.startsWith('DTSTART')) current.DTSTART = value;
      if(key.startsWith('DTEND')) current.DTEND = value;
      if(key === 'SUMMARY') current.SUMMARY = value;
    }
  }
  return events;
}

async function loadAllEvents(){
  const all=[];
  for(const cal of CALENDARS){
    try{
      const res = await fetch(cal.url + '?t=' + Date.now());
      const text = await res.text();
      const events = parseICS(text, cal.key);
      all.push(...events);
    }catch(e){
      console.error('Error loading', cal.name, e);
    }
  }
  return all;
}

function eventsForTodayAndTomorrow(events){
  const today = new Date();
  const tomorrow = new Date(); tomorrow.setDate(today.getDate()+1);
  function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  return { todayEvents: events.filter(ev => isSameDay(ev.start,today)), tomorrowEvents: events.filter(ev => isSameDay(ev.start,tomorrow)) };
}

function computeNowNextLater(events){
  const now = new Date();
  let current=null, next=null; const later=[];
  const sorted = [...events].sort((a,b)=>a.start-b.start);
  for(const ev of sorted){
    const start = ev.start;
    const end = ev.end || new Date(start.getTime() + 60*60*1000);
    if(start <= now && now <= end) current = current || ev;
    else if(start > now){ if(!next) next = ev; else later.push(ev); }
  }
  if(!current && sorted.length>0 && sorted[0].start > now){ next = sorted[0]; later.push(...sorted.slice(1)); }
  return { current, next, later };
}

function renderNowNextLater(events){
  const container = document.getElementById('nowNextLater');
  container.innerHTML = '';
  if(events.length === 0){ container.textContent = 'No events today — enjoy the open space.'; return; }
  const { current, next, later } = computeNowNextLater(events);
  function fmt(ev){ if(!ev) return 'None.'; return ev.start.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' }) + ' • ' + ev.title; }
  container.innerHTML = `
    <div class="nnl-section"><span class="nnl-label">Now:</span> <span class="nnl-text">${current ? fmt(current) : 'Nothing happening right now.'}</span></div>
    <div class="nnl-section"><span class="nnl-label">Next:</span> <span class="nnl-text">${next ? fmt(next) : 'No upcoming events.'}</span></div>
    ${later.length ? `<div class="nnl-section"><span class="nnl-label">Later:</span> <span class="nnl-text">${later.map(ev => ev.start.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' }) + ' ' + ev.title).join(' • ')}</span></div>` : ''}
  `;
}

function renderCalendar(events){
  const container = document.getElementById('calendarEvents');
  const summaryEl = document.getElementById('calendarSummary');
  container.innerHTML = '';

  const { todayEvents, tomorrowEvents } = eventsForTodayAndTomorrow(events);
  const total = todayEvents.length + tomorrowEvents.length;
  summaryEl.textContent = `${total} event${total !== 1 ? 's' : ''} across today and tomorrow`;

  renderNowNextLater(todayEvents);

  function renderSection(title, list){
    const header = document.createElement('div');
    header.style.margin = '12px 0 6px';
    header.style.fontWeight = '700';
    header.style.opacity = '0.95';
    header.style.fontSize = '1.4rem';
    header.textContent = title;
    container.appendChild(header);

    if(list.length === 0){
      const empty = document.createElement('div');
      empty.style.opacity = '0.6';
      empty.style.fontSize = '1.2rem';
      empty.textContent = 'No events.';
      container.appendChild(empty);
      return;
    }

    list.sort((a,b)=>a.start-b.start);
    list.forEach(ev => {
      const cal = CALENDARS.find(c => c.key === ev.sourceKey);
      const timeLabel = ev.start.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' });
      const div = document.createElement('div');
      div.className = 'event';
      div.innerHTML = `
        <div class="event-main">
          <span class="event-dot" style="background:${cal ? cal.color : '#fff'}"></span>
          <span class="event-time">${timeLabel}</span>
          <span class="event-title">${ev.title}</span>
        </div>
        <div class="event-source" style="font-size:1rem; opacity:0.8;">${cal ? cal.name : ''}</div>
        <div class="event-details">${ev.end ? 'Ends at ' + ev.end.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' }) : ''}</div>
      `;
      div.addEventListener('click', ()=> div.classList.toggle('expanded'));
      container.appendChild(div);
    });
  }

  renderSection('Today', todayEvents);
  renderSection('Tomorrow', tomorrowEvents);
}

/* INIT */
async function init(){
  await loadWeather();
  const events = await loadAllEvents();
  renderCalendar(events);
}
init();
</script>
</body>
</html>
