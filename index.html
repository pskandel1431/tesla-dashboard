<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tesla Dashboard</title>

<!-- Feather Icons -->
<script src="https://unpkg.com/feather-icons"></script>

<style>
  body {
    margin: 0;
    padding: 0;
    background: radial-gradient(circle at center, #0b0b0b 0%, #000 70%);
    color: #e8e8e8;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    letter-spacing: 0.2px;
  }

  .top-banner {
    width: 100%;
    padding: 14px 26px;
    background: rgba(255, 255, 255, 0.10);
    backdrop-filter: blur(18px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.22);
    box-shadow: inset 0 0 18px rgba(255,255,255,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .top-left, .top-right {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.15rem;
    opacity: 0.9;
  }

  .top-right {
    opacity: 0.75;
  }

  .page {
    padding: 32px;
    max-width: 1300px;
    margin: auto;
  }

  .grid {
    display: grid;
    grid-template-columns: 1.1fr 1.1fr;
    gap: 24px;
  }

  @media (max-width: 1300px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }

  .card {
    background: rgba(255, 255, 255, 0.10);
    padding: 28px;
    border-radius: 22px;
    backdrop-filter: blur(24px);
    border: 1px solid rgba(255, 255, 255, 0.25);
    box-shadow:
      0 8px 22px rgba(0,0,0,0.55),
      inset 0 0 18px rgba(255,255,255,0.10);
    margin-bottom: 26px;
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
    margin-bottom: 10px;
    opacity: 0.9;
  }

  .time-card {
    font-size: 3.2rem;
    font-weight: 500;
    text-align: center;
    letter-spacing: 1px;
    display: flex;
    justify-content: center;
    gap: 12px;
    align-items: center;
  }

  .time-card span {
    display: inline-block;
  }

  .weather-main {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 10px;
  }

  .weather-icon-big {
    width: 80px;
    filter: drop-shadow(0 0 8px rgba(255,255,255,0.4));
  }

  .weather-temp {
    font-size: 2.4rem;
    font-weight: 500;
  }

  .weather-sub {
    margin-top: 2px;
    opacity: 0.8;
    font-size: 1rem;
  }

  .sunrise-icon,
  .sunset-icon {
    width: 22px;
    vertical-align: middle;
  }

  .sunrise-icon {
    filter: drop-shadow(0 0 4px rgba(255,200,0,0.6));
  }

  .sunset-icon {
    filter: drop-shadow(0 0 4px rgba(255,120,0,0.6));
  }

  .weather-divider {
    border: none;
    border-top: 1px solid rgba(255,255,255,0.15);
    margin: 14px 0;
  }

  .hourly-container {
    overflow-x: auto;
    padding-bottom: 4px;
  }

  .hourly-strip {
    display: flex;
    gap: 12px;
    min-width: max-content;
  }

  .hourly-item {
    min-width: 80px;
    padding: 8px 10px;
    border-radius: 12px;
    background: rgba(255,255,255,0.06);
    text-align: center;
    font-size: 0.9rem;
  }

  .hourly-item img {
    width: 32px;
  }

  .hourly-time {
    opacity: 0.8;
    margin-bottom: 4px;
  }

  .hourly-temp {
    font-weight: 500;
  }

  .forecast-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.12);
    font-size: 0.95rem;
    align-items: center;
  }

  .forecast-row:last-child {
    border-bottom: none;
  }

  .forecast-day {
    width: 60px;
    opacity: 0.85;
  }

  .forecast-icon {
    width: 40px;
    text-align: center;
  }

  .forecast-icon img {
    width: 28px;
  }

  .forecast-temps {
    width: 110px;
    text-align: right;
  }

  .insight {
    margin-top: 10px;
    opacity: 0.75;
    font-size: 0.95rem;
  }

  .calendar-summary {
    opacity: 0.85;
    font-size: 1rem;
    margin-bottom: 8px;
  }

  .calendar-updated {
    opacity: 0.6;
    font-size: 0.85rem;
    margin-bottom: 10px;
  }

  .now-next-later {
    margin-top: 6px;
    font-size: 0.98rem;
  }

  .nnl-section {
    margin-bottom: 6px;
  }

  .nnl-label {
    font-weight: 600;
    opacity: 0.9;
    margin-right: 4px;
  }

  .nnl-text {
    opacity: 0.85;
  }

  .events-list {
    margin-top: 10px;
  }

  .event {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.10);
    font-size: 0.98rem;
    display: flex;
    flex-direction: column;
    gap: 3px;
    cursor: pointer;
  }

  .event:last-child {
    border-bottom: none;
  }

  .event-main {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .event-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .event-time {
    font-weight: 500;
    min-width: 70px;
  }

  .event-title {
    flex: 1;
  }

  .event-source {
    opacity: 0.7;
    font-size: 0.85rem;
    padding-left: 26px;
  }

  .event-details {
    margin-top: 6px;
    padding-left: 26px;
    font-size: 0.9rem;
    opacity: 0.75;
    display: none;
  }

  .event.expanded .event-details {
    display: block;
  }

  .shortcuts-card {
    margin-top: 24px;
  }

  .shortcuts {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .shortcut-btn {
    flex: 1;
    min-width: 220px;
    padding: 18px;
    background: rgba(255,255,255,0.10);
    border: none;
    border-radius: 16px;
    font-size: 1.1rem;
    color: #fff;
    font-weight: 400;
    cursor: pointer;
    transition: background 0.25s ease, transform 0.15s ease, box-shadow 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .shortcut-btn:hover {
    background: rgba(255,255,255,0.16);
    transform: translateY(-2px);
    box-shadow: 0 0 12px rgba(255,255,255,0.18);
  }

  .shortcut-btn i {
    width: 20px;
    height: 20px;
  }
</style>
</head>

<body>
<div class="top-banner">
  <div class="top-left">
    <i data-feather="clock"></i>
    <span id="topTime"></span>
  </div>
  <div class="top-right">
    <i data-feather="refresh-cw"></i>
    <span id="topUpdated"></span>
  </div>
</div>

<div class="page">
  <div class="grid">
    <!-- LEFT COLUMN -->
    <div class="left-col">
      <div class="card time-card" id="timeDisplay">
        <span>--:--</span>
      </div>

      <!-- Unified Weather Hub -->
      <div class="card" id="weatherHub">
        <div class="card-header">
          <i data-feather="cloud"></i>
          <span>Weather</span>
        </div>

        <div id="weatherCurrent"></div>

        <hr class="weather-divider">

        <div id="weatherHourly"></div>

        <hr class="weather-divider">

        <div id="weatherDaily"></div>

        <div class="insight" id="weatherInsight"></div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="right-col">
      <div class="card">
        <div class="card-header">
          <i data-feather="calendar"></i>
          <span>Today’s Schedule</span>
        </div>
        <div class="calendar-summary" id="calendarSummary">Loading your day…</div>
        <div class="calendar-updated" id="calendarUpdated"></div>
        <div class="now-next-later" id="nowNextLater"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <i data-feather="list"></i>
          <span>All Events Today & Tomorrow</span>
        </div>
        <div class="events-list" id="calendarEvents">Loading events…</div>
      </div>
    </div>
  </div>

  <div class="card shortcuts-card">
    <div class="card-header">
      <i data-feather="zap"></i>
      <span>Shortcuts</span>
    </div>
    <div class="shortcuts">
      <button class="shortcut-btn" onclick="window.location.href='https://us83.tribalwars.us/game.php?village=2878&screen=main'">
        <i data-feather='target'></i> Game
      </button>

      <button class="shortcut-btn" onclick="window.location.href='https://dash.tessie.com/'">
        <i data-feather='cpu'></i> Tessie
      </button>

      <button class="shortcut-btn">
        <i data-feather='star'></i> Coming Soon
      </button>
    </div>
  </div>
</div>

<script>
feather.replace();

// CLOCK
function updateTime() {
  const now = new Date();

  const dateStr = now.toLocaleDateString([], {
    weekday: "long",
    month: "long",
    day: "numeric"
  });

  const timeStr = now.toLocaleTimeString([], {
    hour: "numeric",
    minute: "2-digit"
  });

  const banner = `${dateStr} | ${timeStr}`;

  document.getElementById("topTime").textContent = banner;

  document.getElementById("timeDisplay").innerHTML =
    '<i data-feather="clock"></i><span>' + timeStr + "</span>";

  feather.replace();
}
setInterval(updateTime, 1000);
updateTime();

// OPENWEATHER CONFIG
const OPENWEATHER_API_KEY = "89c3522f7c542a2f0aaa7cacf8d6ef28";
const LAT = 42.2043;
const LON = -72.6162;
const UNITS = "imperial";

// Meteocons mapping
function getMeteocon(iconCode) {
  const map = {
    "01d": "clear-day",
    "01n": "clear-night",
    "02d": "partly-cloudy-day",
    "02n": "partly-cloudy-night",
    "03d": "cloudy",
    "03n": "cloudy",
    "04d": "overcast",
    "04n": "overcast",
    "09d": "rain",
    "09n": "rain",
    "10d": "rain",
    "10n": "rain",
    "11d": "thunderstorms",
    "11n": "thunderstorms",
    "13d": "snow",
    "13n": "snow",
    "50d": "mist",
    "50n": "mist"
  };

  const key = map[iconCode] || "cloudy";
  return `https://basmilius.github.io/weather-icons/production/fill/all/${key}.svg`;
}

function generateWeatherNarrative(current, forecast) {
  const descMain = current.weather[0].main.toLowerCase();
  const temp = Math.round(current.main.temp);

  let narrative = `It’s currently ${temp}°F with ${descMain}.`;

  if (descMain.includes("snow")) narrative += " Roads may be slick — allow extra travel time.";
  if (descMain.includes("rain")) narrative += " Expect wet conditions — visibility may be reduced.";
  if (descMain.includes("wind")) narrative += " Strong winds could impact driving.";
  if (descMain.includes("storm")) narrative += " Thunderstorms possible — stay alert.";

  const next12 = forecast.list.slice(0, 4).map(f => f.weather[0].main.toLowerCase());
  if (next12.some(w => w.includes("snow"))) narrative += " Snow is expected later today.";
  if (next12.some(w => w.includes("rain"))) narrative += " Rain is likely in the next few hours.";
  if (next12.some(w => w.includes("wind"))) narrative += " Windy conditions are expected soon.";

  return narrative;
}

// WEATHER + FORECAST
async function loadWeather() {
  try {
    const currentUrl =
      `https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&units=${UNITS}&appid=${OPENWEATHER_API_KEY}`;
    const forecastUrl =
      `https://api.openweathermap.org/data/2.5/forecast?lat=${LAT}&lon=${LON}&units=${UNITS}&appid=${OPENWEATHER_API_KEY}`;

    const [currentRes, forecastRes] = await Promise.all([
      fetch(currentUrl),
      fetch(forecastUrl)
    ]);

    const current = await currentRes.json();
    const forecast = await forecastRes.json();

    renderCurrentWeather(current);
    renderHourly(forecast);
    renderForecast(forecast);

    document.getElementById("topUpdated").textContent =
      "Updated " + new Date().toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

    document.getElementById("weatherInsight").textContent =
      generateWeatherNarrative(current, forecast);
  } catch (e) {
    console.error("Weather error", e);
    document.getElementById("weatherCurrent").textContent = "Weather unavailable";
  }
}

function renderCurrentWeather(data) {
  const temp = Math.round(data.main.temp);
  const feels = Math.round(data.main.feels_like);
  const desc = data.weather[0].description;
  const city = data.name;
  const iconCode = data.weather[0].icon;

  const sunrise = new Date(data.sys.sunrise * 1000)
    .toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

  const sunset = new Date(data.sys.sunset * 1000)
    .toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

  const iconUrl = getMeteocon(iconCode);

  document.getElementById("weatherCurrent").innerHTML = `
    <div class="weather-main">
      <img src="${iconUrl}" class="weather-icon-big" />
      <div>
        <div class="weather-temp">${temp}°F</div>
        <div class="weather-sub">${city} • ${desc}</div>
        <div class="weather-sub">Feels like ${feels}°F</div>
        <div class="weather-sub">
          <img src="https://basmilius.github.io/weather-icons/production/fill/all/sunrise.svg" class="sunrise-icon">
          ${sunrise}
          &nbsp;&nbsp;
          <img src="https://basmilius.github.io/weather-icons/production/fill/all/sunset.svg" class="sunset-icon">
          ${sunset}
        </div>
      </div>
    </div>
  `;
}

function renderHourly(data) {
  const container = document.getElementById("weatherHourly");
  container.innerHTML = `
    <div class="card-header" style="margin-bottom:8px; padding:0;">
      <i data-feather="clock"></i>
      <span>Next 8 Hours</span>
    </div>
    <div class="hourly-container">
      <div class="hourly-strip" id="hourlyStrip"></div>
    </div>
  `;
  feather.replace();

  const strip = document.getElementById("hourlyStrip");
  strip.innerHTML = "";

  const now = Date.now();
  const upcoming = data.list.filter(entry => entry.dt * 1000 > now).slice(0, 8);

  upcoming.forEach(entry => {
    const dt = new Date(entry.dt * 1000);
    const timeLabel = dt.toLocaleTimeString([], { hour: "numeric" });
    const temp = Math.round(entry.main.temp);
    const iconCode = entry.weather[0].icon;
    const iconUrl = getMeteocon(iconCode);

    const div = document.createElement("div");
    div.className = "hourly-item";
    div.innerHTML = `
      <div class="hourly-time">${timeLabel}</div>
      <img src="${iconUrl}" alt="${entry.weather[0].description}" />
      <div class="hourly-temp">${temp}°</div>
    `;
    strip.appendChild(div);
  });

  if (upcoming.length === 0) {
    strip.textContent = "No upcoming hours available.";
  }
}

function renderForecast(data) {
  const container = document.getElementById("weatherDaily");
  container.innerHTML = `
    <div class="card-header" style="margin-bottom:8px; padding:0;">
      <i data-feather="cloud-snow"></i>
      <span>5-Day Forecast</span>
    </div>
    <div id="forecastContainer"></div>
  `;
  feather.replace();

  const fc = document.getElementById("forecastContainer");
  fc.innerHTML = "";

  const byDay = {};
  data.list.forEach(entry => {
    const dt = new Date(entry.dt * 1000);
    const dayKey = dt.toISOString().slice(0, 10);
    if (!byDay[dayKey] || dt.getHours() === 12) {
      byDay[dayKey] = entry;
    }
  });

  const days = Object.keys(byDay).slice(0, 5);

  days.forEach(dayKey => {
    const entry = byDay[dayKey];
    const dt = new Date(entry.dt * 1000);
    const label = dt.toLocaleDateString([], { weekday: "short" });
    const min = Math.round(entry.main.temp_min);
    const max = Math.round(entry.main.temp_max);
    const iconCode = entry.weather[0].icon;
    const iconUrl = getMeteocon(iconCode);

    const row = document.createElement("div");
    row.className = "forecast-row";
    row.innerHTML = `
      <div class="forecast-day">${label}</div>
      <div class="forecast-icon"><img src="${iconUrl}" alt="${entry.weather[0].description}" /></div>
      <div class="forecast-temps">${min}° / ${max}°</div>
    `;
    fc.appendChild(row);
  });
}

// CALENDAR SOURCES
const CALENDARS = [
  {
    name: "Personal",
    key: "personal",
    url: "https://calendar.google.com/calendar/ical/pskandelmail%40gmail.com/private-3f860a04fb0570102688170b52564c42/basic.ics",
    color: "#4f9cff"
  },
  {
    name: "Kenyon",
    key: "kenyon",
    url: "https://pskandel1431.github.io/tesla-dashboard/calendars/kenyon.ics",
    color: "#9b59b6"
  },
  {
    name: "Family",
    key: "family",
    url: "https://calendar.google.com/calendar/ical/eiusan2qer3qb66dragfdqv6n4%40group.calendar.google.com/private-6aa24b9fdb6c890da5038ca012dfd501/basic.ics",
    color: "#27ae60"
  }
];

// ICS DATE PARSER
function parseICalDate(value) {
  const raw = value.split(":").pop();

  if (!raw.includes("T")) {
    const year = Number(raw.slice(0, 4));
    const month = Number(raw.slice(4, 6)) - 1;
    const day = Number(raw.slice(6, 8));
    return new Date(year, month, day);
  }

  const [datePart, timePartRaw] = raw.split("T");
  const timePart = timePartRaw.replace("Z", "");

  const year = Number(datePart.slice(0, 4));
  const month = Number(datePart.slice(4, 6)) - 1;
  const day = Number(datePart.slice(6, 8));

  const hour = Number(timePart.slice(0, 2));
  const minute = Number(timePart.slice(2, 4));
  const second = Number(timePart.slice(4, 6) || "0");

  const isUTC = timePartRaw.endsWith("Z");

  return isUTC
    ? new Date(Date.UTC(year, month, day, hour, minute, second))
    : new Date(year, month, day, hour, minute, second);
}

// ICS PARSER
function parseICS(text, sourceKey) {
  const events = [];
  const lines = text.split(/\r?\n/);
  let current = null;

  for (let line of lines) {
    if (line.startsWith("BEGIN:VEVENT")) {
      current = {};
    } else if (line.startsWith("END:VEVENT")) {
      if (current.DTSTART && current.SUMMARY) {
        events.push({
          title: current.SUMMARY,
          start: parseICalDate(current.DTSTART),
          end: current.DTEND ? parseICalDate(current.DTEND) : null,
          sourceKey
        });
      }
      current = null;
    } else if (current) {
      const [key, ...rest] = line.split(":");
      const value = rest.join(":");
      if (key.startsWith("DTSTART")) current.DTSTART = value;
      if (key.startsWith("DTEND")) current.DTEND = value;
      if (key === "SUMMARY") current.SUMMARY = value;
    }
  }

  return events;
}

// LOAD ALL CALENDARS
async function loadAllEvents() {
  const all = [];
  for (const cal of CALENDARS) {
    try {
      const res = await fetch(cal.url + "?t=" + Date.now());
      const text = await res.text();
      const events = parseICS(text, cal.key);
      all.push(...events);
    } catch (e) {
      console.error("Error loading", cal.name, e);
    }
  }
  return all;
}

// TODAY + TOMORROW
function eventsForTodayAndTomorrow(events) {
  const today = new Date();
  const tomorrow = new Date();
  tomorrow.setDate(today.getDate() + 1);

  function isSameDay(dateA, dateB) {
    return (
      dateA.getFullYear() === dateB.getFullYear() &&
      dateA.getMonth() === dateB.getMonth() &&
      dateA.getDate() === dateB.getDate()
    );
  }

  const todayEvents = events.filter(ev => isSameDay(ev.start, today));
  const tomorrowEvents = events.filter(ev => isSameDay(ev.start, tomorrow));

  return { todayEvents, tomorrowEvents };
}

// NOW / NEXT / LATER
function computeNowNextLater(events) {
  const now = new Date();
  let current = null;
  let next = null;
  const later = [];

  const sorted = [...events].sort((a, b) => a.start - b.start);

  for (const ev of sorted) {
    const start = ev.start;
    const end = ev.end || new Date(start.getTime() + 60 * 60 * 1000);

    if (start <= now && now <= end) {
      current = current || ev;
    } else if (start > now) {
      if (!next) next = ev;
      else later.push(ev);
    }
  }

  if (!current && sorted.length > 0 && sorted[0].start > now) {
    next = sorted[0];
    later.push(...sorted.slice(1));
  }

  return { current, next, later };
}

function renderNowNextLater(events) {
  const container = document.getElementById("nowNextLater");
  container.innerHTML = "";

  if (events.length === 0) {
    container.textContent = "No events today — enjoy the open space.";
    return;
  }

  const { current, next, later } = computeNowNextLater(events);

  function formatEvent(ev) {
    if (!ev) return "None.";
    const time = ev.start.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
    return `${time} • ${ev.title}`;
  }

  const sections = [];

  sections.push(`
    <div class="nnl-section">
      <span class="nnl-label">Now:</span>
      <span class="nnl-text">${current ? formatEvent(current) : "Nothing happening right now."}</span>
    </div>
  `);

  sections.push(`
    <div class="nnl-section">
      <span class="nnl-label">Next:</span>
      <span class="nnl-text">${next ? formatEvent(next) : "No upcoming events."}</span>
    </div>
  `);

  if (later.length > 0) {
    const laterText = later
      .map(ev => {
        const t = ev.start.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
        return `${t} ${ev.title}`;
      })
      .join(" • ");
    sections.push(`
      <div class="nnl-section">
        <span class="nnl-label">Later:</span>
        <span class="nnl-text">${laterText}</span>
      </div>
    `);
  }

  container.innerHTML = sections.join("");
}

// RENDER CALENDAR (Today + Tomorrow)
function renderCalendar(events) {
  const container = document.getElementById("calendarEvents");
  const summaryEl = document.getElementById("calendarSummary");
  const updatedEl = document.getElementById("calendarUpdated");
  container.innerHTML = "";

  updatedEl.textContent =
    "Calendar updated " +
    new Date().toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

  const { todayEvents, tomorrowEvents } = eventsForTodayAndTomorrow(events);

  const total = todayEvents.length + tomorrowEvents.length;
  summaryEl.textContent =
    `${total} event${total !== 1 ? "s" : ""} across today and tomorrow`;

  renderNowNextLater(todayEvents);

  function renderSection(title, list) {
    const header = document.createElement("div");
    header.style.margin = "12px 0 6px";
    header.style.fontWeight = "600";
    header.style.opacity = "0.85";
    header.textContent = title;
    container.appendChild(header);

    if (list.length === 0) {
      const empty = document.createElement("div");
      empty.style.opacity = "0.6";
      empty.style.fontSize = "0.9rem";
      empty.textContent = "No events.";
      container.appendChild(empty);
      return;
    }

    list.sort((a, b) => a.start - b.start);

    list.forEach(ev => {
      const cal = CALENDARS.find(c => c.key === ev.sourceKey);
      const timeLabel = ev.start.toLocaleTimeString([], {
        hour: "numeric",
        minute: "2-digit"
      });

      const div = document.createElement("div");
      div.className = "event";
      div.innerHTML = `
        <div class="event-main">
          <span class="event-dot" style="background:${cal ? cal.color : "#fff"}"></span>
          <span class="event-time">${timeLabel}</span>
          <span class="event-title">${ev.title}</span>
        </div>
        <div class="event-source">${cal ? cal.name : ""}</div>
        <div class="event-details">
          ${ev.end ? "Ends at " + ev.end.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" }) : ""}
        </div>
      `;

      div.addEventListener("click", () => {
        div.classList.toggle("expanded");
      });

      container.appendChild(div);
    });
  }

  renderSection("Today", todayEvents);
  renderSection("Tomorrow", tomorrowEvents);
}

// INIT
async function init() {
  await loadWeather();
  const events = await loadAllEvents();
  renderCalendar(events);
}

init();
</script>
</body>
</html>
